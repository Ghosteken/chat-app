<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Chat Backend Test</title>
    <style>
      body { font-family: sans-serif; max-width: 900px; margin: 20px auto; }
      .row { margin: 8px 0; }
      pre { background: #f5f5f5; padding: 10px; height: 160px; overflow: auto; }
      input, button { padding: 6px; }
      #messages { height: 220px; }
    </style>
  </head>
  <body>
    <h1>Chat Demo</h1>

    <section class="row" id="auth">
      <strong>1) Sign in</strong>
      <div>
        <label>Email <input id="email" placeholder="alice@example.com" /></label>
        <label>Password <input id="password" type="password" value="secret123" /></label>
        <label style="margin-left:10px">Name (for register) <input id="name" placeholder="Alice" /></label>
      </div>
      <div>
        <button id="login">Login</button>
        <button id="register">Register</button>
        <span id="authStatus" style="margin-left:8px;color:#555"></span>
      </div>
    </section>

    <section class="row" id="rooms" style="display:none">
      <strong>2) Rooms</strong>
      <div style="margin-top:6px">
        <label>My rooms <select id="myRooms"></select></label>
        <button id="selectRoom">Open</button>
        <span id="currentRoomLabel" style="margin-left:8px"></span>
      </div>
      <div style="margin-top:6px">
        <label>Name <input id="roomName" placeholder="General" /></label>
        <label>Private <input id="isPrivate" type="checkbox" /></label>
        <button id="createRoom">Create</button>
        <span id="inviteInfo" style="margin-left:8px;color:#555"></span>
      </div>
      <div style="margin-top:6px">
        <label>Join by ID <input id="roomId" size="6" /></label>
        <label>Invite <input id="inviteCode" size="12" placeholder="if private"/></label>
        <button id="joinRoom">Join</button>
        <button id="loadMembers">Members</button>
      </div>
    </section>

    <section class="row" id="chat" style="display:none">
      <strong>3) Chat</strong>
      <div id="typing" style="height:18px;color:#888;margin:6px 0"></div>
      <pre id="messages"></pre>
      <div style="margin-top:6px">
        <input id="message" placeholder="Type a message" size="60" />
        <button id="send">Send</button>
      </div>
    </section>

    <section class="row" id="eventsWrap" style="display:none">
      <strong>Events</strong>
      <pre id="events"></pre>
    </section>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      const qs = (id) => document.getElementById(id);
      const append = (el, m) => { el.textContent += m + "\n"; el.scrollTop = el.scrollHeight; };
      const eventsEl = qs('events');
      const messagesEl = qs('messages');
      const typingEl = qs('typing');

      let token = '';
      let socket = null;
      let currentRoomId = null;
      let typingTimer = null;

      const api = (path, method='GET', body) => fetch('/api' + path, {
        method, headers: { 'Content-Type': 'application/json', ...(token ? { Authorization: 'Bearer ' + token } : {}) },
        body: body ? JSON.stringify(body) : undefined
      }).then(r => r.json());

      async function onAuth(r){
        if(r.token){ token = r.token; qs('authStatus').textContent = 'Authenticated'; qs('rooms').style.display='block'; qs('eventsWrap').style.display='block'; await loadRooms(); connectSocket(); }
        else { qs('authStatus').textContent = (r.error || 'Auth failed'); }
      }

      qs('login').onclick = async()=> onAuth(await api('/auth/login','POST',{ email: qs('email').value, password: qs('password').value }));
      qs('register').onclick = async()=> onAuth(await api('/auth/register','POST',{ name: qs('name').value, email: qs('email').value, password: qs('password').value }));

      async function loadRooms(){
        const rooms = await api('/rooms');
        const sel = qs('myRooms'); sel.innerHTML='';
        rooms.forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=`#${r.id} ${r.name}`; sel.appendChild(o); });
      }

      function connectSocket(){
        if(socket) socket.disconnect();
        socket = io('/', { auth: { token } });
        socket.on('receive_message', (p)=> { append(messagesEl, `[${p.roomId}] ${p.senderId}: ${p.content}`); });
        socket.on('user_status', (p)=> append(eventsEl, `user_status: ${JSON.stringify(p)}`));
        socket.on('typing', (p)=> { typingEl.textContent = p.isTyping ? `User ${p.userId} is typing...` : ''; });
      }

      async function selectRoomById(id){
        currentRoomId = parseInt(id,10); qs('currentRoomLabel').textContent = `Current: #${currentRoomId}`;
        if(socket) socket.emit('join_room', { roomId: currentRoomId });
        qs('chat').style.display='block';
        messagesEl.textContent='';
        const hist = await api(`/rooms/${currentRoomId}/messages?limit=50`);
        (hist.messages || []).slice().reverse().forEach(m=> append(messagesEl, `[${m.roomId}] ${m.senderId}: ${m.content}`));
      }

      qs('selectRoom').onclick = ()=> selectRoomById(qs('myRooms').value);
      qs('createRoom').onclick = async()=>{
        const r = await api('/rooms','POST',{ name: qs('roomName').value, isPrivate: qs('isPrivate').checked });
        append(eventsEl, 'created room: ' + JSON.stringify(r));
        if(r.id){ await loadRooms(); qs('myRooms').value = r.id; await selectRoomById(r.id); }
        qs('inviteInfo').textContent = r.inviteCode ? `Invite: ${r.inviteCode}` : '';
      };
      qs('joinRoom').onclick = async()=>{
        const r = await api(`/rooms/${qs('roomId').value}/join`, 'POST', { inviteCode: qs('inviteCode').value || undefined });
        append(eventsEl, 'join room: ' + JSON.stringify(r));
        await loadRooms();
      };
      qs('loadMembers').onclick = async()=>{
        const m = await api(`/rooms/${qs('roomId').value || qs('myRooms').value}/members`);
        append(eventsEl, 'members: ' + JSON.stringify(m));
      };

      qs('send').onclick = ()=>{
        const content = qs('message').value.trim();
        if(!content || !currentRoomId || !socket) return;
        socket.emit('send_message', { roomId: currentRoomId, content });
        qs('message').value='';
      };

      qs('message').addEventListener('input', ()=>{
        if(!socket || !currentRoomId) return;
        socket.emit('typing', { roomId: currentRoomId, isTyping: true });
        clearTimeout(typingTimer);
        typingTimer = setTimeout(()=> socket.emit('typing', { roomId: currentRoomId, isTyping: false }), 1000);
      });
    </script>
  </body>
</html>

